<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub to Markdown Converter</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/markdown.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-4">GitHub to Markdown Converter</h1>
        <div id="auth-section" class="mb-4">
            <button id="github-login" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700">Sign in with GitHub</button>
            <span id="user-info" class="ml-4 hidden"></span>
        </div>
        <form id="repo-form" class="mb-4 hidden">
            <input type="text" id="repo-url" placeholder="Enter GitHub repo URL" required class="w-full p-2 border rounded mb-2">
            <input type="text" id="exclude-types" placeholder="Exclude file types (e.g., .pyc,.txt)" class="w-full p-2 border rounded mb-2">
            <input type="text" id="exclude-dirs" placeholder="Exclude directories (comma-separated)" class="w-full p-2 border rounded mb-2">
            <input type="text" id="exclude-files" placeholder="Exclude specific files (comma-separated)" class="w-full p-2 border rounded mb-2">
            <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Convert</button>
        </form>
        <div id="result" class="bg-white p-4 rounded shadow hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Generated Markdown</h2>
                <button id="copy-button" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Copy</button>
            </div>
            <pre id="markdown-display" class="bg-gray-100 p-4 rounded overflow-auto max-h-96"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const clientId = 'Ov23li5mLRGHTrnFJ7nY';
            const redirectUri = 'https://gh-md.netlify.app/.netlify/functions/github-callback';
            let accessToken = null;

            const githubLoginButton = document.getElementById('github-login');
            const userInfo = document.getElementById('user-info');
            const repoForm = document.getElementById('repo-form');
            const result = document.getElementById('result');
            const markdownDisplay = document.getElementById('markdown-display');
            const copyButton = document.getElementById('copy-button');

            githubLoginButton.addEventListener('click', () => {
                window.location.href = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=repo`;
            });

            // Check if we have an access token in the URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('access_token');
            if (token) {
                accessToken = token;
                githubLoginButton.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.textContent = 'Signed in';
                repoForm.classList.remove('hidden');
                // Remove the access token from the URL
                window.history.replaceState({}, document.title, "/");
            }

            repoForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const repoUrl = document.getElementById('repo-url').value;
                const excludeTypes = document.getElementById('exclude-types').value;
                const excludeDirs = document.getElementById('exclude-dirs').value;
                const excludeFiles = document.getElementById('exclude-files').value;
                result.classList.remove('hidden');
                result.innerHTML = 'Converting...';

                try {
                    const response = await fetch('/.netlify/functions/github-to-markdown', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            repoUrl, 
                            excludeTypes, 
                            excludeDirs, 
                            excludeFiles 
                        }),
                    });
                    const data = await response.json();
                    
                    if (response.ok) {
                        markdownDisplay.textContent = data.markdown;
                        markdownDisplay.innerHTML = '```markdown\n' + escapeHtml(data.markdown) + '\n```';
                        result.classList.remove('hidden');
                        hljs.highlightElement(markdownDisplay);
                    } else if (response.status === 401) {
                        throw new Error('Unauthorized: Please sign in with GitHub again.');
                    } else {
                        throw new Error(data.error || 'Failed to convert repository');
                    }
                } catch (error) {
                    result.textContent = `Error: ${error.message}`;
                }
            });

            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Markdown copied to clipboard!');
                }, (err) => {
                    console.error('Could not copy text: ', err);
                });
            }

            copyButton.addEventListener('click', () => {
                const markdownContent = markdownDisplay.textContent;
                copyToClipboard(markdownContent);
            });
        });
    </script>
</body>
</html>